// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  output        = "../lib/generated/prisma"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - Represents students and admins
model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique // Clerk authentication ID
  email     String   @unique
  name      String
  avatar    String?
  role      UserRole @default(student)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  enrollments     Enrollment[]
  progress        Progress[]
  notes           Note[]
  tasks           Task[]
  studySessions   StudySession[]
  bookmarks       Bookmark[]
  userSettings    UserSettings?
    favorites       UserFavorite[]
  quizAttempts    QuizAttempt[]
  studyGroups     StudyGroup[]      // Groups created by user
  groupMessages   StudyGroupMessage[]
  groupMembership StudyGroupMember[]

  @@map("users")
}

enum UserRole {
  student
  admin
  teacher
}

// Course model - Main course structure
model Course {
  id             String    @id @default(cuid())
  title          String
  description    String
  subject        Subject
  level          Level     @default(gcse)
  thumbnail      String?
  instructor     String
  instructorId   String?
  duration       Int       // in minutes
  difficulty     Difficulty @default(beginner)
  topics         String[]  // Array of topic tags
  status         CourseStatus @default(draft)
  enrollmentCount Int       @default(0)
  rating         Float     @default(0)
  price          Float     @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  chapters    Chapter[]
  enrollments Enrollment[]
  progress    Progress[]
  quizzes     Quiz[]
  notes       Note[]
  tasks       Task[]
  bookmarks   Bookmark[]
  studySessions StudySession[]
    favorites   UserFavorite[]
  tags        CourseTag[]
  studyGroups StudyGroup[]

  @@map("courses")
}

enum Subject {
  mathematics
  english
  science
  history
  geography
  other
}

enum Level {
  gcse
  igcse
  a_level
}

enum Difficulty {
  beginner
  intermediate
  advanced
}

enum CourseStatus {
  draft
  published
  archived
}

// Chapter model - Organizes lessons within courses
model Chapter {
  id          String   @id @default(cuid())
  courseId    String
  title       String
  description String
  order       Int
  duration    Int      // in minutes
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course   Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons  Lesson[]
  quizzes  Quiz[]
  progress Progress[]
  notes    Note[]
  tasks    Task[]
  bookmarks Bookmark[]

  @@map("chapters")
}

// Lesson model - Individual lesson content
model Lesson {
  id           String   @id @default(cuid())
  chapterId    String
  title        String
  description  String
  content      String?  // Rich text content
  videoUrl     String?
  videoDuration Int?     // in seconds
  markdownPath String?  // Path to markdown file
  hasVideo     Boolean  @default(false)
  hasMarkdown  Boolean  @default(false)
  order        Int
  duration     Int      // in minutes
  isPublished  Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  chapter       Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  progress      Progress[]
  quizzes       Quiz[]
  notes         Note[]
  tasks         Task[]
  bookmarks     Bookmark[]
  studySessions StudySession[]

  @@map("lessons")
}

// Enrollment model - Tracks user course enrollments
model Enrollment {
  id          String          @id @default(cuid())
  userId      String
  courseId    String
  enrolledAt  DateTime        @default(now())
  completedAt DateTime?
  progress    Float           @default(0) // 0-100 percentage
  status      EnrollmentStatus @default(active)

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@map("enrollments")
}

enum EnrollmentStatus {
  active
  completed
  paused
  dropped
}

// Progress model - Tracks user progress through courses
model Progress {
  id           String          @id @default(cuid())
  userId       String
  courseId     String
  chapterId    String?
  lessonId     String?
  status       ProgressStatus  @default(not_started)
  startedAt    DateTime?
  completedAt  DateTime?
  timeSpent    Int             @default(0) // in minutes
  score        Float?          // quiz/exam score
  lastAccessed DateTime        @default(now())

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  chapter Chapter? @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  lesson  Lesson?  @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId, chapterId, lessonId])
  @@map("progress")
}

enum ProgressStatus {
  not_started
  in_progress
  completed
}

// Quiz model - Assessment functionality
model Quiz {
  id            String   @id @default(cuid())
  lessonId      String?
  chapterId     String?
  courseId      String?
  title         String
  description   String
  timeLimit     Int?     // in minutes
  passingScore  Float    @default(70) // percentage
  maxAttempts   Int      @default(3)
  isPublished   Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  lesson   Lesson?  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  chapter  Chapter? @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  course   Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions Question[]
  attempts QuizAttempt[]

  @@map("quizzes")
}

// Question model - Individual quiz questions
model Question {
  id            String          @id @default(cuid())
  quizId        String
  question      String
  type          QuestionType
  options       String?         // For multiple choice (JSON string)
  correctAnswer String
  explanation   String?
  points        Int             @default(1)
  order         Int

  // Relations
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@map("questions")
}

enum QuestionType {
  multiple_choice
  true_false
  short_answer
  essay
}

// QuizAttempt model - Tracks quiz attempts
model QuizAttempt {
  id           String   @id @default(cuid())
  userId       String
  quizId       String
  score        Float
  passed       Boolean
  startedAt    DateTime @default(now())
  completedAt  DateTime?
  timeSpent    Int      @default(0) // in minutes
  attemptNumber Int

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz    Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers QuizAnswer[]

  @@map("quiz_attempts")
}

// QuizAnswer model - Individual question answers
model QuizAnswer {
  id          String @id @default(cuid())
  attemptId   String
  questionId  String
  userAnswer  String
  isCorrect   Boolean
  points      Int

  // Relations
  attempt  QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  // question Question - handled through quizId in attempt

  @@map("quiz_answers")
}

// Note model - User notes
model Note {
  id        String   @id @default(cuid())
  userId    String
  courseId  String?
  chapterId String?
  lessonId  String?
  title     String
  content   String   // Rich text content
  tags      String[]
  isPrivate Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course  Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  chapter Chapter? @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  lesson  Lesson?  @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@map("notes")
}

// Task model - User tasks and assignments
model Task {
  id          String     @id @default(cuid())
  userId      String
  title       String
  description String?
  courseId    String?
  chapterId   String?
  lessonId    String?
  priority    TaskPriority @default(medium)
  status      TaskStatus   @default(pending)
  dueDate     DateTime?
  completedAt DateTime?
  tags        String[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course  Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  chapter Chapter? @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  lesson  Lesson?  @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@map("tasks")
}

enum TaskPriority {
  low
  medium
  high
}

enum TaskStatus {
  pending
  in_progress
  completed
  cancelled
}

// StudySession model - Tracks user study sessions
model StudySession {
  id           String   @id @default(cuid())
  userId       String
  courseId     String?
  lessonId     String?
  startTime    DateTime @default(now())
  endTime      DateTime?
  duration     Int      // in minutes
  pagesRead    Int?
  videosWatched Int?
  notes        String?

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course  Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson  Lesson?  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  activities StudyActivity[]

  @@map("study_sessions")
}

// StudyActivity model - Detailed tracking of activities within study sessions
model StudyActivity {
  id         String      @id @default(cuid())
  sessionId  String
  type       ActivityType
  resourceId String      // lessonId, quizId, etc.
  startTime  DateTime    @default(now())
  endTime    DateTime?
  duration   Int         // in minutes
  data       Json?       // Additional activity-specific data

  // Relations
  session StudySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("study_activities")
}

enum ActivityType {
  watch_video
  read_markdown
  take_quiz
  take_notes
  practice_exercise
}

// Bookmark model - User bookmarks
model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  courseId  String?
  chapterId String?
  lessonId  String?
  timestamp Int?     // For video bookmarks
  note      String?
  createdAt DateTime @default(now())

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course  Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  chapter Chapter? @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  lesson  Lesson?  @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId, chapterId, lessonId])
  @@map("bookmarks")
}

// UserSettings model - User preferences and settings
model UserSettings {
  id String @id @default(cuid())
  userId String @unique

  theme Theme @default(light)
  emailNotifications Boolean @default(true)
  pushNotifications Boolean @default(true)
  studyReminders Boolean @default(true)
  deadlineReminders Boolean @default(true)
  dailyGoal Int @default(60) // minutes
  preferredStudyTime StudyTime @default(evening)
  studyDays Json // Store as JSON array [0-6 (Sunday-Saturday)]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

enum Theme {
  light
  dark
  system
}

enum StudyTime {
  morning
  afternoon
  evening
}


// CourseTag model - Course tags for categorization
model CourseTag {
  courseId String
  tag      String

  // Relations
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@id([courseId, tag])
  @@map("course_tags")
}

// UserFavorite model - User favorited courses
model UserFavorite {
  userId    String
  courseId  String
  createdAt DateTime @default(now())

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@id([userId, courseId])
  @@map("user_favorites")
}

// StudyGroup model - Collaborative study groups
model StudyGroup {
  id          String   @id @default(cuid())
  name        String
  description String?
  courseId    String
  creatorId   String
  isPrivate   Boolean  @default(false)
  memberCount Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course   Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  creator  User                @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  members  StudyGroupMember[]
  messages StudyGroupMessage[]

  @@map("study_groups")
}

// StudyGroupMember model - Group membership
model StudyGroupMember {
  groupId String
  userId  String
  role    GroupRole @default(member)
  joinedAt DateTime @default(now())

  // Relations
  group StudyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([groupId, userId])
  @@map("study_group_members")
}

enum GroupRole {
  owner
  moderator
  member
}

// StudyGroupMessage model - Group chat messages
model StudyGroupMessage {
  id           String          @id @default(cuid())
  groupId      String
  userId       String
  content      String
  type         MessageType     @default(text)
  attachments  Json? // Array of attachment URLs
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Relations
  group StudyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("study_group_messages")
}

enum MessageType {
  text
  file
  link
}